<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>液体迷宫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background-color: #ffffff;
            border: 5px solid #888;
            box-sizing: border-box;
        }
        #info {
            text-align: center;
            font-size: 18px;
            position: absolute;
            width: 100%;
            top: 10px;
            color: #333;
        }
        #startButton {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 50px;
            padding: 10px 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas" width="400" height="600"></canvas>
<div id="info">
    分数：<span id="score">0</span> 关卡：<span id="level">1</span>
</div>
<button id="startButton">开始游戏</button>

<!-- 引入 Matter.js 物理引擎 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.17.1/matter.min.js"></script>

<script>
// 模块别名
const Engine = Matter.Engine,
      Render = Matter.Render,
      Runner = Matter.Runner,
      Bodies = Matter.Bodies,
      Body = Matter.Body,
      Composite = Matter.Composite,
      Events = Matter.Events,
      Constraint = Matter.Constraint;

// 创建引擎
let engine = Engine.create();
let world = engine.world;

// 获取画布和上下文
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const render = Render.create({
    canvas: canvas,
    engine: engine,
    options: {
        width: canvas.width,
        height: canvas.height,
        wireframes: false,
        background: '#ffffff'
    }
});

// 定义游戏变量
let droplet;        // 液滴
let traps = [];     // 陷阱数组
let goal;           // 终点
let bounds;         // 边界
let isGameOver = false;
let isGameWin = false;
let ax = 0, ay = 0; // 加速度（根据晃动获取）
let level = 1;      // 初始关卡
let score = 0;      // 初始得分

// 初始化游戏
function initGame() {
    // 重置世界
    Composite.clear(world);
    Engine.clear(engine);
    isGameOver = false;
    isGameWin = false;
    document.getElementById('startButton').style.display = 'none';

    // 更新关卡和得分显示
    document.getElementById('level').innerText = level;
    document.getElementById('score').innerText = score;

    // 创建边界
    let thickness = 50;
    bounds = [
        Bodies.rectangle(canvas.width / 2, -thickness / 2, canvas.width, thickness, { isStatic: true }), // 上
        Bodies.rectangle(canvas.width / 2, canvas.height + thickness / 2, canvas.width, thickness, { isStatic: true }), // 下
        Bodies.rectangle(-thickness / 2, canvas.height / 2, thickness, canvas.height, { isStatic: true }), // 左
        Bodies.rectangle(canvas.width + thickness / 2, canvas.height / 2, thickness, canvas.height, { isStatic: true }) // 右
    ];
    Composite.add(world, bounds);

    // 创建液滴（软体）
    droplet = Bodies.circle(canvas.width / 2, canvas.height - 100, 30, {
        density: 0.04,
        frictionAir: 0.005,
        restitution: 0.2,
        render: { fillStyle: 'blue' }
    });
    Composite.add(world, droplet);

    // 创建终点（黄色方块）在顶部
    goal = Bodies.rectangle(Math.random() * (canvas.width - 100) + 50, 100, 60, 60, {
        isStatic: true,
        render: { fillStyle: 'yellow' }
    });
    Composite.add(world, goal);

    // 创建陷阱
    generateTraps();

    // 获取传感器数据
    initSensors();

    // 运行引擎和渲染器
    Engine.run(engine);
    Render.run(render);

    // 事件监听
    setupEvents();
}

// 生成陷阱
function generateTraps() {
    traps = [];
    let trapCount = level + 2; // 每一关的陷阱数量增加
    let safeZone = {
        x: droplet.position.x - 100,
        y: droplet.position.y - 100,
        width: 200,
        height: 200
    };

    for (let i = 0; i < trapCount; i++) {
        let trap;
        let isInSafeZone;
        do {
            let x = Math.random() * (canvas.width - 60) + 30;
            let y = Math.random() * (canvas.height - 300) + 150;
            trap = Bodies.rectangle(x, y, 40, 40, {
                isStatic: true,
                render: { fillStyle: 'red' }
            });
            isInSafeZone = (x > safeZone.x && x < safeZone.x + safeZone.width &&
                            y > safeZone.y && y < safeZone.y + safeZone.height);
        } while (isInSafeZone);
        traps.push(trap);
    }
    Composite.add(world, traps);
}

// 初始化传感器
function initSensors() {
    // 检测设备类型
    if (window.DeviceMotionEvent) {
        // 移动设备
        window.addEventListener('devicemotion', function(event) {
            ax = -event.accelerationIncludingGravity.x / 10; // 根据需要调整系数
            ay = event.accelerationIncludingGravity.y / 10;
        }, true);
    } else {
        // PC设备，使用键盘控制
        ax = 0;
        ay = 0;
        window.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 'ArrowLeft':
                    ax = -0.05;
                    break;
                case 'ArrowRight':
                    ax = 0.05;
                    break;
                case 'ArrowUp':
                    ay = -0.05;
                    break;
                case 'ArrowDown':
                    ay = 0.05;
                    break;
            }
        });
        window.addEventListener('keyup', function(event) {
            ax = 0;
            ay = 0;
        });
    }
}

// 事件监听
function setupEvents() {
    // 每次更新
    Events.on(engine, 'beforeUpdate', function() {
        if (isGameOver || isGameWin) return;

        // 施加力（模拟倾斜）
        Body.applyForce(droplet, droplet.position, { x: ax * droplet.mass, y: ay * droplet.mass });

        // 检查是否到达终点
        if (Matter.SAT.collides(droplet, goal).collided) {
            isGameWin = true;
            gameWin();
        }

        // 检查是否碰到陷阱
        for (let trap of traps) {
            if (Matter.SAT.collides(droplet, trap).collided) {
                isGameOver = true;
                gameOver();
                break;
            }
        }

        // 检查是否流出边界
        if (droplet.position.x < 0 || droplet.position.x > canvas.width ||
            droplet.position.y < 0 || droplet.position.y > canvas.height) {
            // 模拟液体流失，减小液滴大小
            droplet.circleRadius *= 0.9;
            if (droplet.circleRadius < 10) {
                isGameOver = true;
                gameOver();
            } else {
                Body.scale(droplet, 0.9, 0.9);
            }
        }
    });
}

// 游戏胜利
function gameWin() {
    score += level * 10; // 增加得分
    level++; // 关卡增加
    document.getElementById('score').innerText = score;
    document.getElementById('startButton').innerText = '进入第 ' + level + ' 关';
    document.getElementById('startButton').style.display = 'block';
}

// 游戏失败
function gameOver() {
    document.getElementById('startButton').innerText = '游戏结束，点击重新开始';
    document.getElementById('startButton').style.display = 'block';
    level = 1; // 重置关卡
    score = 0; // 重置得分
}

// 点击开始按钮
document.getElementById('startButton').addEventListener('click', function() {
    initGame();
});

// 页面加载后自动显示开始按钮
window.onload = function() {
    document.getElementById('startButton').style.display = 'block';
};

</script>

</body>
</html>
