<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Maze Game - Version 1.5</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>
    <style>
        #score-display {
            position: absolute;
            top: 40px;
            left: 10px;
            color: white;
            font-size: 16px;
        }
        #level-display {
            position: absolute;
            top: 70px;
            left: 10px;
            color: white;
            font-size: 16px;
        }
    </style>
    <style>
        #start-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-size: 24px;
        }
        #start-button {
            padding: 10px 20px;
            font-size: 20px;
            cursor: pointer;
        }
        #restart-button {
            position: absolute;
            top: 100px;
            left: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: none;
        }
    </style>
</head>
<body>
<script>
    let scene, camera, renderer;
    let liquid, goal, traps = [], collectibles = [];
    let tilt = { x: 0, y: 0 };
    let isResetting = false;
    let floor;
    let world, liquidBody, floorBody;
    let score = 0;
    let level = 1;
    const collectiblesCount = 5;

    function createJoystickControl() {
        // Create joystick control in the bottom right corner
        const joystick = document.createElement('div');
        joystick.style.position = 'absolute';
        joystick.style.right = '20px';
        joystick.style.bottom = '20px';
        joystick.style.width = '100px';
        joystick.style.height = '100px';
        joystick.style.borderRadius = '50%';
        joystick.style.background = 'rgba(255, 255, 255, 0.5)';
        joystick.style.display = 'flex';
        joystick.style.alignItems = 'center';
        joystick.style.justifyContent = 'center';
        joystick.style.fontSize = '24px';
        joystick.style.color = 'black';
        joystick.style.cursor = 'pointer';
        joystick.innerText = 'Joystick';
        document.body.appendChild(joystick);

        // Implement joystick functionality
        joystick.addEventListener('mousedown', () => {
            // Example tilt behavior, you can adjust this to your needs
            tilt.x -= 0.1;
            tilt.y -= 0.1;
        });
    }

    function createControlButtons() {
        // Create arrow buttons for control
        const controlContainer = document.createElement('div');
        controlContainer.style.position = 'absolute';
        controlContainer.style.left = '10px';
        controlContainer.style.bottom = '20px';
        controlContainer.style.display = 'flex';
        controlContainer.style.flexDirection = 'column';
        controlContainer.style.alignItems = 'center';

        const directions = ['ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight'];
        const arrowSymbols = ['⬆️', '⬅️', '⬇️', '➡️'];

        directions.forEach((direction, index) => {
            const button = document.createElement('button');
            button.innerText = arrowSymbols[index];
            button.style.fontSize = '20px';
            button.style.margin = '5px';
            button.style.cursor = 'pointer';

            button.addEventListener('mousedown', () => {
                handleKey({ key: direction });
            });

            controlContainer.appendChild(button);
        });

        document.body.appendChild(controlContainer);
    }

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('restart-button').style.display = 'block';
        init();
    }

    function restartGame() {
        isResetting = false;
        score = 0;
        level = 1;
        document.getElementById('score-display').innerText = `Score: ${score}`;
        document.getElementById('level-display').innerText = `Level: ${level}`;
        // Reset world
        world = new CANNON.World();
        world.gravity.set(0, -9.82, 0);

        // Clear scene
        while (scene.children.length > 0) {
            scene.remove(scene.children[0]);
        }

        // Reinitialize game objects
        init();
    }

    function init() {
        const startButton = document.getElementById('start-button');
        if (startButton) {
            startButton.addEventListener('click', startGame);
        }
        // Physics world setup
        world = new CANNON.World();
        world.gravity.set(0, -9.82, 0);

        // Scene setup
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 20, 20);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Ambient light
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 10, 10);
        scene.add(light);

        // Floor
        const floorGeometry = new THREE.BoxGeometry(20, 1, 20);
        const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x808080 });
        floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.position.y = -0.5;
        scene.add(floor);

        // Floor physics
        const floorShape = new CANNON.Box(new CANNON.Vec3(10, 0.5, 10));
        floorBody = new CANNON.Body({ mass: 0 });
        floorBody.addShape(floorShape);
        floorBody.position.set(0, -0.5, 0);
        world.addBody(floorBody);

        // Liquid (Player) - Using shaders for a liquid effect
        const liquidGeometry = new THREE.SphereGeometry(1, 64, 64);
        const liquidMaterial = new THREE.ShaderMaterial({
            uniforms: {
                time: { value: 0.0 }
            },
            vertexShader: `
                uniform float time;
                varying vec3 vNormal;
                void main() {
                    vNormal = normal;
                    vec3 newPosition = position + normal * sin(position.x * 10.0 + time) * 0.1;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
                }
            `,
            fragmentShader: `
                varying vec3 vNormal;
                void main() {
                    gl_FragColor = vec4(0.0, 1.0, 0.8, 0.8);
                }
            `,
            transparent: true
        });
        liquid = new THREE.Mesh(liquidGeometry, liquidMaterial);
        scene.add(liquid);

        // Liquid physics
        const liquidShape = new CANNON.Sphere(1);
        liquidBody = new CANNON.Body({ mass: 5 });
        liquidBody.addShape(liquidShape);
        liquidBody.position.set(0, 1, 0);
        liquidBody.linearDamping = 0.9;  // Simulate viscosity
        world.addBody(liquidBody);

        // Goal (Yellow Block)
        const goalGeometry = new THREE.BoxGeometry(2, 2, 2);
        const goalMaterial = new THREE.MeshStandardMaterial({ color: 0xffff00 });
        goal = new THREE.Mesh(goalGeometry, goalMaterial);
        goal.position.set(8, 1, 8);
        scene.add(goal);

        // Add initial traps (Red Blocks)
        for (let i = 0; i < collectiblesCount; i++) {
            addCollectible();
        }
        for (let i = 0; i < 3; i++) {
            addTrap();
        }

        // Event listeners for tilt
        window.addEventListener('deviceorientation', handleOrientation);
        document.addEventListener('keydown', handleKey);
        createJoystickControl();
        createControlButtons();
        window.addEventListener('keydown', handleKey);

        animate();
    }

    function addTrap() {
        const trapGeometry = new THREE.BoxGeometry(2, 2, 2);
        const trapMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
        const trap = new THREE.Mesh(trapGeometry, trapMaterial);
        trap.position.set((Math.random() - 0.5) * 18, 1, (Math.random() - 0.5) * 18);
        traps.push(trap);
        scene.add(trap);
    }

    function addCollectible() {
        const collectibleGeometry = new THREE.SphereGeometry(0.5, 32, 32);
        const collectibleMaterial = new THREE.MeshStandardMaterial({ color: 0xffff00 });
        const collectible = new THREE.Mesh(collectibleGeometry, collectibleMaterial);
        collectible.position.set((Math.random() - 0.5) * 18, 1, (Math.random() - 0.5) * 18);
        collectibles.push(collectible);
        scene.add(collectible);
    }

    function nextLevel() {
        level++;
        document.getElementById('level-display').innerText = `Level: ${level}`;
        liquidBody.position.set(0, 1, 0);
        liquidBody.velocity.set(0, 0, 0);
        floor.scale.set(level, 1, level);
        world.removeBody(floorBody);
        const floorShape = new CANNON.Box(new CANNON.Vec3(10 * level, 0.5, 10 * level));
        floorBody = new CANNON.Body({ mass: 0 });
        floorBody.addShape(floorShape);
        floorBody.position.set(0, -0.5, 0);
        world.addBody(floorBody);

        // Add more traps and collectibles
        for (let i = 0; i < level; i++) {
            addTrap();
            addCollectible();
        }
        isResetting = false;
    }

    function handleOrientation(event) {
        tilt.x = event.beta / 90;  // Tilt range -90 to 90
        tilt.y = event.gamma / 90; // Tilt range -45 to 45
    }

    function handleKey(event) {
        if (event.key === 'ArrowUp') tilt.x = Math.max(tilt.x - 0.1, -1);
        if (event.key === 'ArrowDown') tilt.x = Math.min(tilt.x + 0.1, 1);
        if (event.key === 'ArrowLeft') tilt.y = Math.max(tilt.y - 0.1, -1);
        if (event.key === 'ArrowRight') tilt.y = Math.min(tilt.y + 0.1, 1);
    }

    function animate() {
        requestAnimationFrame(animate);

        if (isResetting) return;

        // Step the physics world
        world.step(1 / 60);

        // Apply tilt to the floor
        floorBody.quaternion.setFromEuler(tilt.x * 0.1, 0, tilt.y * 0.1);
        floor.quaternion.copy(floorBody.quaternion);

        // Sync liquid position with physics body
        liquid.position.copy(liquidBody.position);
        liquid.quaternion.copy(liquidBody.quaternion);

        // Update shader uniform time to create liquid effect
        liquid.material.uniforms.time.value += 0.05;

        // Check if liquid falls off the platform
        if (liquid.position.y < -5) {
            isResetting = true;
            alert("You fell off the platform!");
            setTimeout(() => {
                restartGame();
            }, 500);
            return;
        }

        // Collision detection with goal
        if (liquidBody.position.distanceTo(new CANNON.Vec3(goal.position.x, goal.position.y, goal.position.z)) < 2) {
            isResetting = true;
            alert("You reached the goal!");
            setTimeout(() => {
                nextLevel();
            }, 500);
        }

        // Collision detection with traps
        traps.forEach(trap => {
            const trapPosition = new CANNON.Vec3(trap.position.x, trap.position.y, trap.position.z);
            if (liquidBody.position.distanceTo(trapPosition) < 2) {
                isResetting = true;
                alert("You hit a trap!");
                setTimeout(() => {
                    restartGame();
                }, 500);
            }
        });

        // Collision detection with collectibles
        collectibles.forEach((collectible, index) => {
            if (liquidBody.position.distanceTo(new CANNON.Vec3(collectible.position.x, collectible.position.y, collectible.position.z)) < 1.5) {
                scene.remove(collectible);
                collectibles.splice(index, 1);
                score += 10;
                document.getElementById('score-display').innerText = `Score: ${score}`;
            }
        });

        // Adjust camera to keep the liquid in view
        camera.position.set(liquid.position.x, 20, liquid.position.z + 20);
        camera.lookAt(liquid.position);

        renderer.render(scene, camera);
    }

    init();
</script>
<div id="version-display" style="position: absolute; top: 10px; left: 10px; color: white; font-size: 16px;">Version 1.5</div>
<div id="score-display">Score: 0</div>
<div id="level-display">Level: 1</div>
<div id="start-screen">
    <p>Welcome to Liquid Maze Game</p>
    <button id="start-button">Start Game</button>
</div>
<button id="restart-button" onclick="restartGame()">Restart</button>
</body>
</html>
