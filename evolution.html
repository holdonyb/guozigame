<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>快乐的吞噬小宝宝</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #e0f7fa;
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background-color: #ffffff;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 16px;
            color: #000;
        }
        #taskPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            color: #000;
        }
        #gameOver {
            position: absolute;
            top: 40%;
            width: 100%;
            text-align: center;
            font-size: 48px;
            color: red;
            display: none;
        }
        /* 新增的触摸控制按钮样式 */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            display: flex;
            justify-content: space-between;
        }
        .control-button {
            width: 60px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 30px;
            text-align: center;
            line-height: 60px;
            font-size: 24px;
            user-select: none;
        }
        #skillButton {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 40px;
            text-align: center;
            line-height: 80px;
            font-size: 24px;
            user-select: none;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="1280" height="720"></canvas>
    <div id="ui"></div>
    <div id="taskPanel"></div>
    <div id="gameOver">游戏结束！</div>

    <!-- 新增的触摸控制按钮 -->
    <div id="controls">
        <div id="leftBtn" class="control-button">←</div>
        <div id="upBtn" class="control-button">↑</div>
        <div id="downBtn" class="control-button">↓</div>
        <div id="rightBtn" class="control-button">→</div>
    </div>
    <div id="skillButton">技能</div>

    <script>
        // 获取画布和上下文
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 定义全局变量
        let players = [];
        let plasmas = [];
        let items = [];
        let tasks = [];
        let achievements = [];
        let keys = {};
        let gameRunning = true;
        let evolutionStages = [
            { stage: '单细胞', size: 10, speed: 3 },
            { stage: '多细胞', size: 15, speed: 2.8 },
            { stage: '小型生物', size: 20, speed: 2.5 },
            { stage: '鱼类', size: 25, speed: 2.2 },
            { stage: '两栖动物', size: 30, speed: 2 },
            { stage: '爬行动物', size: 35, speed: 1.8 },
            { stage: '哺乳动物', size: 40, speed: 1.5 },
            { stage: '灵长类', size: 45, speed: 1.2 },
            { stage: '原始人类', size: 50, speed: 1 },
            { stage: '现代人类', size: 55, speed: 0.8 }
        ];

        // 定义玩家类
        class Player {
            constructor(x, y, isAI = false) {
                this.x = x;
                this.y = y;
                this.size = 10;
                this.speed = 3;
                this.health = 100;
                this.exp = 0;
                this.mutationPoints = 0;
                this.level = 1;
                this.isAI = isAI;
                this.evolutionStage = 0;
                this.target = null;
                this.skills = [];
                this.path = [];
            }

            draw() {
                // 添加外圈使玩家更明显
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size + 2, 0, Math.PI * 2);
                ctx.fillStyle = this.isAI ? '#006400' : '#000'; // AI外圈为深绿，玩家为黑色
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.isAI ? '#66bb6a' : '#42a5f5';
                ctx.fill();
                ctx.closePath();
            }

            move() {
                if (this.isAI) {
                    this.aiMove();
                } else {
                    this.playerMove();
                }
            }

            playerMove() {
                if (keys['up']) this.y -= this.speed;
                if (keys['down']) this.y += this.speed;
                if (keys['left']) this.x -= this.speed;
                if (keys['right']) this.x += this.speed;
                this.boundaryCheck();
            }

            aiMove() {
                // 简单的追踪玩家
                if (player && player.health > 0) {
                    let dx = player.x - this.x;
                    let dy = player.y - this.y;
                    let dist = Math.sqrt(dx * dx + dy * dy);
                    this.x += (dx / dist) * this.speed * 0.5; // 速度减半，避免过于困难
                    this.y += (dy / dist) * this.speed * 0.5;
                    this.boundaryCheck();
                } else {
                    // 没有玩家时，随机移动
                    let direction = Math.floor(Math.random() * 4);
                    switch (direction) {
                        case 0:
                            this.y -= this.speed;
                            break;
                        case 1:
                            this.y += this.speed;
                            break;
                        case 2:
                            this.x -= this.speed;
                            break;
                        case 3:
                            this.x += this.speed;
                            break;
                    }
                    this.boundaryCheck();
                }
            }

            boundaryCheck() {
                if (this.x < this.size) this.x = this.size;
                if (this.x > canvas.width - this.size) this.x = canvas.width - this.size;
                if (this.y < this.size) this.y = this.size;
                if (this.y > canvas.height - this.size) this.y = canvas.height - this.size;
            }

            eat(entity) {
                this.exp += 20;
                this.size += 1;
                this.checkLevelUp();
                checkAchievements('collectPlasma', 1);
            }

            attack(other) {
                let damage = 5 + this.level;
                other.health -= damage;
                if (other.health <= 0) {
                    this.exp += other.level * 50;
                    this.checkLevelUp();
                    checkAchievements('defeatEnemy', 1);
                }
            }

            checkLevelUp() {
                if (this.exp >= this.level * 100) {
                    this.exp -= this.level * 100;
                    this.level++;
                    this.mutationPoints++;
                    this.evolve();
                }
            }

            evolve() {
                if (this.evolutionStage < evolutionStages.length - 1) {
                    this.evolutionStage++;
                    let stageInfo = evolutionStages[this.evolutionStage];
                    this.size = stageInfo.size;
                    this.speed = stageInfo.speed;
                    this.unlockSkill();
                    checkAchievements('evolve', this.evolutionStage);
                } else {
                    // 进化成人类，游戏胜利
                    if (!this.isAI) {
                        gameOver('恭喜你进化成人类，赢得了游戏！');
                    } else {
                        gameOver('AI玩家进化成人类，AI胜利！');
                    }
                }
            }

            unlockSkill() {
                switch (this.evolutionStage) {
                    case 2:
                        this.skills.push('加速');
                        break;
                    case 4:
                        this.skills.push('跳跃');
                        break;
                    case 6:
                        this.skills.push('防御');
                        break;
                    case 8:
                        this.skills.push('特殊攻击');
                        break;
                    default:
                        break;
                }
            }

            useSkill(skillName) {
                if (this.skills.includes(skillName)) {
                    switch (skillName) {
                        case '加速':
                            if (!this.isAccelerating) {
                                this.isAccelerating = true;
                                this.speed *= 1.5;
                                setTimeout(() => {
                                    this.speed /= 1.5;
                                    this.isAccelerating = false;
                                }, 2000);
                            }
                            break;
                        // 其他技能实现略
                        default:
                            break;
                    }
                }
            }
        }

        // 定义等离子类
        class Plasma {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = 8;
                this.health = 50;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = '#ef5350';
                ctx.fill();
                ctx.closePath();
            }
        }

        // 定义物品类
        class Item {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.size = 10;
                this.type = type; // 'speed', 'health', 'exp', 'attack', 'defense'
            }

            draw() {
                ctx.beginPath();
                ctx.rect(this.x - this.size / 2, this.y - this.size / 2, this.size, this.size);
                ctx.fillStyle = this.type === 'speed' ? '#ab47bc' :
                                this.type === 'health' ? '#66bb6a' :
                                this.type === 'exp' ? '#ffee58' :
                                this.type === 'attack' ? '#ff7043' : '#29b6f6';
                ctx.fill();
                ctx.closePath();
            }

            applyEffect(player) {
                switch (this.type) {
                    case 'speed':
                        player.speed += 0.5;
                        break;
                    case 'health':
                        player.health += 20;
                        if (player.health > 100) player.health = 100;
                        break;
                    case 'exp':
                        player.exp += 50;
                        player.checkLevelUp();
                        break;
                    // 其他物品效果略
                    default:
                        break;
                }
            }
        }

        // 初始化玩家和AI
        let player = new Player(canvas.width / 2, canvas.height / 2);
        players.push(player);

        for (let i = 0; i < 10; i++) {
            let aiPlayer = new Player(Math.random() * canvas.width, Math.random() * canvas.height, true);
            players.push(aiPlayer);
        }

        // 初始化等离子
        for (let i = 0; i < 50; i++) {
            let plasma = new Plasma(Math.random() * canvas.width, Math.random() * canvas.height);
            plasmas.push(plasma);
        }

        // 初始化物品
        function spawnItems() {
            let itemTypes = ['speed', 'health', 'exp', 'attack', 'defense'];
            for (let i = 0; i < 20; i++) {
                let itemType = itemTypes[Math.floor(Math.random() * itemTypes.length)];
                let item = new Item(Math.random() * canvas.width, Math.random() * canvas.height, itemType);
                items.push(item);
            }
        }
        spawnItems();

        // 初始化任务和成就（此处简单实现）
        function checkAchievements(task, value) {
            // 简单地输出一下，用于避免错误
            console.log(`Achievement checked: ${task}, value: ${value}`);
        }

        // 更新UI（简单实现）
        function updateUI() {
            const ui = document.getElementById('ui');
            ui.innerHTML = `
                等级: ${player.level}，经验: ${player.exp}/${player.level * 100}，生命值: ${player.health}<br>
                按键状态：上=${keys['up'] ? '按下' : '松开'}，下=${keys['down'] ? '按下' : '松开'}，
                左=${keys['left'] ? '按下' : '松开'}，右=${keys['right'] ? '按下' : '松开'}
            `;
        }

        // 游戏结束函数
        function gameOver(message) {
            gameRunning = false;
            const gameOverDiv = document.getElementById('gameOver');
            gameOverDiv.innerText = message;
            gameOverDiv.style.display = 'block';
        }

        // 游戏主循环
        function gameLoop() {
            if (!gameRunning) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 绘制等离子
            plasmas.forEach(plasma => {
                plasma.draw();
            });

            // 绘制物品
            items.forEach(item => {
                item.draw();
            });

            // 更新和绘制玩家
            players.forEach(p => {
                p.move();
                p.draw();

                // 吃等离子
                plasmas.forEach((plasma, index) => {
                    if (isColliding(p, plasma)) {
                        p.eat(plasma);
                        plasmas.splice(index, 1);
                    }
                });

                // 收集物品
                items.forEach((item, index) => {
                    if (isColliding(p, item)) {
                        item.applyEffect(p);
                        items.splice(index, 1);
                    }
                });

                // 攻击其他玩家
                players.forEach(other => {
                    if (other !== p && isColliding(p, other)) {
                        if (p.size > other.size) {
                            p.attack(other);
                        } else if (p.size < other.size) {
                            other.attack(p);
                        }
                    }
                });

                // 检查玩家是否死亡
                if (p.health <= 0) {
                    if (!p.isAI) {
                        gameOver('你已经死亡，游戏结束！');
                    } else {
                        // 移除死亡的AI玩家
                        players.splice(players.indexOf(p), 1);
                    }
                }
            });

            // 更新UI
            updateUI();

            requestAnimationFrame(gameLoop);
        }

        // 碰撞检测函数
        function isColliding(obj1, obj2) {
            let dx = obj1.x - obj2.x;
            let dy = obj1.y - obj2.y;
            let distance = Math.sqrt(dx * dx + dy * dy);
            return distance < obj1.size + obj2.size;
        }

        // 事件监听
        window.addEventListener('keydown', function(e) {
            // e.preventDefault(); // 注释掉以防止影响浏览器默认行为
            switch (e.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    keys['up'] = true;
                    break;
                case 's':
                case 'arrowdown':
                    keys['down'] = true;
                    break;
                case 'a':
                case 'arrowleft':
                    keys['left'] = true;
                    break;
                case 'd':
                case 'arrowright':
                    keys['right'] = true;
                    break;
                case 'e':
                    player.useSkill('加速');
                    break;
                default:
                    break;
            }
        });

        window.addEventListener('keyup', function(e) {
            switch (e.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    keys['up'] = false;
                    break;
                case 's':
                case 'arrowdown':
                    keys['down'] = false;
                    break;
                case 'a':
                case 'arrowleft':
                    keys['left'] = false;
                    break;
                case 'd':
                case 'arrowright':
                    keys['right'] = false;
                    break;
                default:
                    break;
            }
        });

        // 触摸控制按钮事件处理
        function setupTouchControls() {
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            const upBtn = document.getElementById('upBtn');
            const downBtn = document.getElementById('downBtn');
            const skillBtn = document.getElementById('skillButton');

            leftBtn.addEventListener('touchstart', () => { keys['left'] = true; });
            leftBtn.addEventListener('touchend', () => { keys['left'] = false; });
            rightBtn.addEventListener('touchstart', () => { keys['right'] = true; });
            rightBtn.addEventListener('touchend', () => { keys['right'] = false; });
            upBtn.addEventListener('touchstart', () => { keys['up'] = true; });
            upBtn.addEventListener('touchend', () => { keys['up'] = false; });
            downBtn.addEventListener('touchstart', () => { keys['down'] = true; });
            downBtn.addEventListener('touchend', () => { keys['down'] = false; });

            skillBtn.addEventListener('touchstart', () => {
                player.useSkill('加速');
            });
        }

        setupTouchControls();

        // 开始游戏
        gameLoop();
    </script>
</body>
</html>
